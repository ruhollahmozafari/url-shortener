# URL Shortener

A production-ready URL shortener built with FastAPI, featuring advanced caching, message queuing, and analytics capabilities.

## üéØ Features

- **Fast Redirects**: < 2ms with Redis caching
- **Scalable Architecture**: Supports thousands of requests per second
- **Analytics**: Track hits, device types, browsers, and more
- **Batch Processing**: Efficient hit counting with message queues
- **Multiple Strategies**: Pluggable cache, queue, and storage backends
- **Production-Ready**: Atomic updates, graceful shutdown, error handling

---

## üèóÔ∏è Architecture

### System Design

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   Client    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
       ‚îÇ
       ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         FastAPI Server              ‚îÇ
‚îÇ                                     ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
‚îÇ  ‚îÇ   API    ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ  URL Service ‚îÇ‚îÇ
‚îÇ  ‚îÇ Endpoints‚îÇ     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò            ‚îÇ        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ             ‚îÇ             ‚îÇ
           ‚ñº             ‚ñº             ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ  Redis   ‚îÇ  ‚îÇ  SQLite  ‚îÇ  ‚îÇ  Queue   ‚îÇ
    ‚îÇ  Cache   ‚îÇ  ‚îÇ   Main   ‚îÇ  ‚îÇ (Redis)  ‚îÇ
    ‚îÇ          ‚îÇ  ‚îÇ   DB     ‚îÇ  ‚îÇ          ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚îÇ
                                      ‚ñº
                              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                              ‚îÇ  Hit Worker    ‚îÇ
                              ‚îÇ (Background)   ‚îÇ
                              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                      ‚îÇ
                        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                        ‚îÇ                            ‚îÇ
                        ‚ñº                            ‚ñº
                 ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                 ‚îÇ Analytics‚îÇ                ‚îÇ  SQLite  ‚îÇ
                 ‚îÇ  SQLite  ‚îÇ                ‚îÇ   Main   ‚îÇ
                 ‚îÇ    DB    ‚îÇ                ‚îÇ    DB    ‚îÇ
                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Key Components

#### 1. **API Layer**
- **FastAPI**: High-performance async web framework
- **Endpoints**: URL creation, retrieval, stats, redirect
- **Validation**: Pydantic schemas for request/response

#### 2. **Service Layer**
- **URL Service**: Business logic for URL operations
- **Strategy Pattern**: Pluggable short code generation (Random, Base62)
- **Dependency Injection**: Clean separation of concerns

#### 3. **Cache Layer** (Strategy Pattern)
- **Redis Cache**: Production caching (< 0.1ms)
- **In-Memory Cache**: Development/testing
- **Null Cache**: Disable caching
- **Cache-Aside Pattern**: Lazy loading with TTL

#### 4. **Queue Layer** (Strategy Pattern)
- **Redis Streams**: Production message queue
- **In-Memory Queue**: Development/testing
- **Message-Driven**: Async hit tracking

#### 5. **Storage Layer** (Strategy Pattern)
- **SQLite**: Main transactional database
- **Analytics SQLite**: Separate analytics database
- **ClickHouse**: High-performance analytics (interface ready)

#### 6. **Background Worker**
- **Batch Processing**: Process 100+ hits at once
- **Atomic Updates**: No race conditions
- **Graceful Shutdown**: Flush pending hits
- **Auto-Retry**: Failed messages stay in queue

---

## üìã Design Patterns Used

### 1. **Strategy Pattern**
- Short code generation (Random vs Base62)
- Cache backends (Redis vs In-Memory vs Null)
- Queue backends (Redis Streams vs In-Memory)
- Storage backends (SQLite vs ClickHouse)

### 2. **Factory Pattern**
- `CacheFactory`: Create cache instances
- `QueueFactory`: Create queue instances
- `HitStorageFactory`: Create storage instances
- `ShortCodeFactory`: Create code generators

### 3. **Singleton Pattern**
- Cache instances (one per application)
- Queue instances (one per application)
- Storage instances (one per application)

### 4. **Dependency Injection**
- FastAPI's `Depends()` for loose coupling
- Service layer receives dependencies
- Easy testing with mocks

### 5. **Repository Pattern**
- SQLAlchemy models abstract data access
- Service layer independent of database

### 6. **Cache-Aside Pattern**
- Check cache first
- On miss, query database
- Populate cache for next time

---

## üöÄ Getting Started

### Prerequisites

- Python 3.11+
- Redis (optional, falls back to in-memory)

### Installation

```bash
# Clone the repository
git clone <repository-url>
cd url_shortener

# Create virtual environment
python -m venv .venv
source .venv/bin/activate  # On Windows: .venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
pip install -r requirements-dev.txt  # For development
```

### Configuration

Create a `.env` file (use `.env.example` as template):

```bash
# Environment
ENVIRONMENT=development
DEBUG=True

# Database
DATABASE_URL=sqlite:///./url_shortener.db

# Cache (Redis)
CACHE_BACKEND=redis
REDIS_URL=redis://localhost:6379/0

# Queue (Redis Streams)
QUEUE_BACKEND=redis_streams
QUEUE_NAME=url_hits

# Analytics Storage
HIT_STORAGE_BACKEND=sqlite
HIT_STORAGE_SQLITE_PATH=analytics.db
```

### Running the Application

#### 1. Start Redis (Optional)
```bash
# Using Docker
docker run -d -p 6379:6379 redis:7-alpine

# Or install locally
# macOS: brew install redis && redis-server
# Ubuntu: sudo apt install redis-server && redis-server
```

#### 2. Start API Server
```bash
# Development mode (with auto-reload)
fastapi dev main.py

# Production mode
uvicorn main:app --host 0.0.0.0 --port 8000
```

#### 3. Start Background Worker
```bash
# In a separate terminal
python -m shortener_app.hit_processor.hit_worker

# Or use the script
chmod +x start_hit_worker.sh
./start_hit_worker.sh
```

---

## üìñ API Documentation

Once the server is running, visit:

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

### API Endpoints

#### Create Short URL
```bash
POST /api/v1/urls/
Content-Type: application/json

{
  "long_url": "https://www.example.com"
}

Response:
{
  "id": 1,
  "long_url": "https://www.example.com/",
  "short_code": "abc12",
  "short_url": "http://localhost:8000/abc12",
  "total_hits": 0,
  "is_active": true,
  "created_at": "2025-10-30T12:00:00Z"
}
```

#### Redirect
```bash
GET /{short_code}

# Redirects to long URL (302 redirect)
# Tracks hit asynchronously via queue
```

#### Get URL Info
```bash
GET /api/v1/urls/{short_code}

Response:
{
  "id": 1,
  "long_url": "https://www.example.com/",
  "short_code": "abc12",
  "short_url": "http://localhost:8000/abc12",
  "total_hits": 42,
  "is_active": true,
  "created_at": "2025-10-30T12:00:00Z"
}
```

#### Get Stats
```bash
GET /api/v1/urls/{short_code}/stats

Response:
{
  "short_code": "abc12",
  "total_hits": 42,
  "created_at": "2025-10-30T12:00:00Z",
  "last_accessed": "2025-10-30T12:30:00Z"
}
```

#### Delete URL
```bash
DELETE /api/v1/urls/{short_code}

Response: 204 No Content
```

---

## üß™ Testing

```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=shortener_app --cov-report=html

# Run specific test file
pytest tests/test_url_shortener.py

# Run with verbose output
pytest -v
```

---

## üîß Configuration Options

### Short Code Strategies

#### Base62 (Recommended)
```python
SHORT_CODE_STRATEGY=base62
SHORT_CODE_SALT=1256  # 4-digit salt

# Generates: abc12, xyz89, etc.
# Supports: 916M unique codes (62^5)
# Deterministic based on ID
```

#### Random
```python
SHORT_CODE_STRATEGY=random
MAX_RETRIES=5

# Generates: random 5-character codes
# Retries on collision
```

### Cache Backends

```python
# Redis (Production)
CACHE_BACKEND=redis
REDIS_URL=redis://localhost:6379/0
CACHE_TTL=3600

# In-Memory (Development)
CACHE_BACKEND=memory

# Null (Disable)
CACHE_BACKEND=null
```

### Queue Backends

```python
# Redis Streams (Production)
QUEUE_BACKEND=redis_streams
REDIS_URL=redis://localhost:6379/0

# In-Memory (Development)
QUEUE_BACKEND=memory
```

### Analytics Storage

```python
# SQLite (Development)
HIT_STORAGE_BACKEND=sqlite
HIT_STORAGE_SQLITE_PATH=analytics.db

# ClickHouse (Production - interface ready)
HIT_STORAGE_BACKEND=clickhouse
HIT_STORAGE_CLICKHOUSE_URL=http://localhost:8123
```

---

## üìä Performance

### Benchmarks

| Operation | Time (with cache) | Time (without cache) |
|-----------|-------------------|----------------------|
| Redirect | ~0.2ms | ~2ms |
| Create URL | ~10ms | ~10ms |
| Get Stats | ~2ms | ~2ms |

### Scalability

- **Horizontal**: Multiple workers supported
- **Vertical**: Handles 1000s of requests/second per worker
- **Database**: 916M+ unique short codes (62^5)

### Optimizations

1. **Caching**: Redis for fast lookups
2. **Batch Processing**: 100 hits processed at once
3. **Atomic Updates**: No race conditions
4. **Connection Pooling**: Reuse database connections
5. **Message Queue**: Async hit tracking

---

## üè≠ Production Deployment

### Recommended Setup

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Load Balancer  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ          ‚îÇ
    ‚ñº          ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ API #1 ‚îÇ  ‚îÇ API #2 ‚îÇ  (Multiple instances)
‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ           ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ            ‚îÇ
    ‚ñº            ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Redis  ‚îÇ  ‚îÇ PostgreSQL ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Worker #1...#N ‚îÇ  (Multiple workers)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    ‚îÇ
    ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ClickHouse    ‚îÇ  (Analytics)
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Environment Variables

```bash
ENVIRONMENT=production
DEBUG=False
DATABASE_URL=postgresql://user:pass@host:5432/db
REDIS_URL=redis://host:6379/0
CACHE_BACKEND=redis
QUEUE_BACKEND=redis_streams
HIT_STORAGE_BACKEND=clickhouse
```

---

## üõ†Ô∏è Development

### Project Structure

```
url_shortener/
‚îú‚îÄ‚îÄ main.py                      # FastAPI application entry point
‚îú‚îÄ‚îÄ requirements.txt             # Production dependencies
‚îú‚îÄ‚îÄ requirements-dev.txt         # Development dependencies
‚îú‚îÄ‚îÄ .env.example                 # Environment variables template
‚îú‚îÄ‚îÄ .gitignore                   # Git ignore rules
‚îÇ
‚îú‚îÄ‚îÄ shortener_app/               # Main application package
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py                # Configuration (Pydantic Settings)
‚îÇ   ‚îú‚îÄ‚îÄ dependencies.py          # FastAPI dependencies (DI)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ api/                     # API endpoints
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ v1/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ urls.py          # URL CRUD endpoints
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ redirect.py      # Redirect endpoint
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ models/                  # SQLAlchemy models
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ url.py               # URL model
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ schemas/                 # Pydantic schemas
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ url.py               # URL request/response schemas
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ services/                # Business logic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ url_service.py       # URL operations
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ short_code_factory.py          # Code generator factory
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ short_code_strategies.py       # Code generation strategies
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ database/                # Database configuration
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ connection.py        # SQLAlchemy setup
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ cache/                   # Caching layer
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategies.py        # Cache implementations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ factory.py           # Cache factory
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ queue/                   # Message queue
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models.py            # Queue message models
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategies.py        # Queue implementations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ factory.py           # Queue factory
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ storage/                 # Analytics storage
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ strategies.py        # Storage implementations
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ factory.py           # Storage factory
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ hit_processor/           # Background workers
‚îÇ       ‚îî‚îÄ‚îÄ hit_worker.py        # Hit processing worker
‚îÇ
‚îî‚îÄ‚îÄ tests/                       # Test suite
    ‚îú‚îÄ‚îÄ conftest.py              # Pytest fixtures
    ‚îî‚îÄ‚îÄ test_url_shortener.py    # URL shortener tests
```

### Code Style

```bash
# Format code
black .
isort .

# Lint code
flake8 .

# Type checking
mypy shortener_app/
```

---

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests
5. Run tests and linting
6. Submit a pull request

---

## üìù License

This project is open source and available under the MIT License.

---

## üôè Acknowledgments

Built with:
- [FastAPI](https://fastapi.tiangolo.com/) - Modern web framework
- [SQLAlchemy](https://www.sqlalchemy.org/) - SQL toolkit and ORM
- [Pydantic](https://pydantic-docs.helpmanual.io/) - Data validation
- [Redis](https://redis.io/) - Caching and message queue
- [pytest](https://pytest.org/) - Testing framework

---

## üìß Contact

For questions or support, please open an issue on GitHub.

---

**Happy URL Shortening!** üéâ

